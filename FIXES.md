# Исправления для MacOS и Windows

## 1. Оставлен только оптимизированный инференс

### Изменения:
- Убрана поддержка гибридного режима инференса (`hybrid`)
- Оставлены только режимы: `model` и `algorithm`
- Упрощена логика в `web/routes.py` - проверка только на `inference_mode == 'model'`

### Файлы:
- `web/routes.py` - убрана проверка `inference_mode in ('model', 'hybrid')`
- `templates/settings.html` - уже содержал только нужные опции

## 2. Исправление проблемы с путями изображений на MacOS

### Проблема:
На MacOS изображения не отображались из-за неправильной обработки абсолютных путей в URL.
Логи показывали ошибки 404 для путей вида:
```
/var/folders/xh/zxlndpg550q7lpk5yv3tbdhc0000gn/T/analysis_session_otvr48t7/BSImages/ВК-все_Конфликт132.png
```

### Решение:
Улучшена функция `download_file` в `web/routes.py`:

1. **Декодирование URL**: Добавлено `urllib.parse.unquote()` для корректного декодирования URL-encoded путей
2. **Обработка абсолютных путей**: Проверка, начинается ли путь с `/` и находится ли он в пределах `session_dir`
3. **Безопасность**: Проверка, что абсолютный путь не выходит за пределы сессии
4. **Корректное имя файла**: Использование `os.path.basename()` для имени скачиваемого файла

### Код:
```python
# Декодируем URL-encoded путь
decoded_filename = urllib.parse.unquote(filename)

# Проверяем, является ли путь абсолютным
if decoded_filename.startswith('/'):
    # Проверяем безопасность
    if not decoded_filename.startswith(session_dir):
        return "Доступ запрещен", 403
    file_path = decoded_filename
else:
    # Обычный относительный путь
    file_path = os.path.join(session_dir, decoded_filename)
```

## 3. Исправление проблемы с сохранением ручной разметки на Windows

### Проблема:
На Windows возникали ошибки при сохранении файлов `manual_review.json` и `df_with_inference.csv`, что приводило к потере ручной разметки.

### Решение:

#### 3.1 Надежное сохранение JSON
В функции `api_manual_review` добавлена многоуровневая обработка ошибок:

1. **Первая попытка**: Стандартная запись с форматированием
2. **Вторая попытка**: Запись во временный файл с последующим переименованием
3. **Третья попытка**: Запись без форматирования
4. **Проверка**: Верификация, что файл создался и содержит правильные данные

#### 3.2 Надежное чтение JSON
В функции `apply_manual_review` добавлена обработка кодировок:

1. **Первая попытка**: Чтение с `utf-8`
2. **Вторая попытка**: Чтение с `latin-1` (для Windows)
3. **Проверка данных**: Валидация содержимого файла

#### 3.3 Надежное сохранение CSV
Во всех функциях (`analyze_files`, `api_manual_review`, `api_updated_stats`) добавлена:

1. **Первая попытка**: Сохранение с `encoding='utf-8'`
2. **Вторая попытка**: Сохранение во временный файл с переименованием
3. **Обработка ошибок**: Логирование всех попыток

#### 3.4 Надежное чтение CSV
Во всех функциях добавлена обработка кодировок:

1. **Первая попытка**: Чтение с `utf-8`
2. **Вторая попытка**: Чтение с `latin-1`
3. **Проверка данных**: Валидация DataFrame

### Код для сохранения JSON:
```python
try:
    with open(review_path, 'w', encoding='utf-8') as f:
        json.dump(reviews, f, ensure_ascii=False, indent=2)
except Exception as e:
    # Альтернативный способ для Windows
    temp_path = os.path.join(session_dir, 'manual_review_temp.json')
    with open(temp_path, 'w', encoding='utf-8') as f:
        json.dump(reviews, f, ensure_ascii=False, indent=2)
    if os.path.exists(review_path):
        os.remove(review_path)
    os.rename(temp_path, review_path)
```

### Код для чтения JSON:
```python
try:
    with open(review_path, 'r', encoding='utf-8') as f:
        reviews = json.load(f)
except UnicodeDecodeError:
    with open(review_path, 'r', encoding='latin-1') as f:
        reviews = json.load(f)
```

## 4. Дополнительные улучшения

### 4.1 Логирование
- Добавлено подробное логирование всех операций
- Логирование статистики ручной разметки
- Логирование ошибок с контекстом

### 4.2 Валидация данных
- Проверка существования файлов после записи
- Валидация количества сохраненных записей
- Проверка целостности DataFrame

### 4.3 Обработка ошибок
- Graceful degradation при ошибках
- Возврат понятных сообщений об ошибках
- Сохранение частичных результатов

## Результат

1. **MacOS**: Изображения теперь корректно отображаются благодаря правильной обработке абсолютных путей
2. **Windows**: Ручная разметка надежно сохраняется благодаря многоуровневой обработке ошибок
3. **Кроссплатформенность**: Система работает одинаково на всех ОС
4. **Надежность**: Добавлена защита от потери данных при ошибках записи/чтения 