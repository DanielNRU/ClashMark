# Исправления для MacOS и Windows

## 1. Оставлен только оптимизированный инференс

### Изменения:
- Убрана поддержка гибридного режима инференса (`hybrid`)
- Оставлены только режимы: `model` и `algorithm`
- Упрощена логика в `web/routes.py` - проверка только на `inference_mode == 'model'`
- **Удалена опция "Включить оптимизацию инференса"** - оптимизация теперь всегда включена

### Файлы:
- `web/routes.py` - убрана проверка `inference_mode in ('model', 'hybrid')`, убрано использование `use_optimization`
- `templates/settings.html` - удалена опция "Включить оптимизацию инференса"
- `web/settings.py` - убрана обработка `use_optimization` из настроек
- `ml/model.py` - функция `get_cached_model` теперь всегда использует оптимизацию

### Логика работы режима "модель":
1. **Алгоритмическая разметка** - применяется ко всем коллизиям на основе пар категорий
2. **Модельная разметка** - применяется только к коллизиям, которые не были разметы алгоритмом (visual и unknown пары)
3. **Ручная разметка** - применяется поверх всех предыдущих разметок

## 2. Исправление проблемы с путями изображений на MacOS

### Проблема:
На MacOS изображения не отображались из-за неправильной обработки абсолютных путей в URL.
Логи показывали ошибки 404 для путей вида:
```
/var/folders/xh/zxlndpg550q7lpk5yv3tbdhc0000gn/T/analysis_session_otvr48t7/BSImages/ВК-все_Конфликт132.png
```

### Решение:
Улучшена функция `download_file` в `web/routes.py`:

1. **Декодирование URL**: Добавлено `urllib.parse.unquote()` для корректного декодирования URL-encoded путей
2. **Обработка абсолютных путей**: Проверка, начинается ли путь с `/` и находится ли он в пределах `session_dir`
3. **Безопасность**: Проверка, что абсолютный путь не выходит за пределы сессии
4. **Корректное имя файла**: Использование `os.path.basename()` для имени скачиваемого файла

### Код:
```python
# Декодируем URL-encoded путь
decoded_filename = urllib.parse.unquote(filename)

# Проверяем, является ли путь абсолютным (начинается с /)
if decoded_filename.startswith('/'):
    # Это абсолютный путь, проверяем безопасность
    if not decoded_filename.startswith(session_dir):
        return "Доступ запрещен", 403
    file_path = decoded_filename
else:
    # Относительный путь
    file_path = os.path.join(session_dir, decoded_filename)
```

## 3. Исправление проблемы с сохранением ручной разметки на Windows

### Проблема:
На Windows возникали ошибки при сохранении JSON файлов с ручной разметкой из-за проблем с кодировкой и правами доступа.

### Решение:
Добавлена многоуровневая обработка ошибок при работе с файлами:

1. **Надежное сохранение JSON**: Альтернативные методы записи с использованием временных файлов
2. **Обработка кодировок**: Поддержка UTF-8 и latin-1 при чтении файлов
3. **Надежное сохранение CSV**: Альтернативные методы записи CSV файлов
4. **Обработка ошибок**: Логирование всех ошибок и fallback методы

### Код:
```python
# Сохраняем разметку в файл
try:
    with open(review_path, 'w', encoding='utf-8') as f:
        json.dump(reviews, f, ensure_ascii=False, indent=2)
except Exception as e:
    # Альтернативный способ для Windows
    temp_path = os.path.join(session_dir, 'manual_review_temp.json')
    with open(temp_path, 'w', encoding='utf-8') as f:
        json.dump(reviews, f, ensure_ascii=False, indent=2)
    os.rename(temp_path, review_path)
```

## 4. Улучшения совместимости

### Чтение файлов:
- Добавлена поддержка разных кодировок (UTF-8, latin-1)
- Обработка ошибок при чтении CSV и JSON файлов
- Fallback методы для проблемных файлов

### Запись файлов:
- Использование временных файлов для атомарной записи
- Обработка ошибок доступа к файлам
- Альтернативные методы записи для Windows

### Пути к файлам:
- Корректная обработка абсолютных путей на MacOS
- Безопасная проверка путей
- Поддержка URL-encoded имен файлов

## Результат:
- ✅ Изображения корректно отображаются на MacOS
- ✅ Ручная разметка сохраняется на Windows
- ✅ Упрощена логика инференса (только оптимизированный режим)
- ✅ Улучшена совместимость с разными ОС 