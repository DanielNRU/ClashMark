# Исправления проблем с сохранением настроек

## Обзор исправлений

В данном документе описаны исправления, внесенные для устранения проблемы с сохранением настроек "Архитектура модели" и "Оптимизация инференса" в веб-интерфейсе.

## 1. Проблема

### Описание
Настройки "Архитектура модели" (`model_type`) и "Оптимизация инференса" (`use_optimization`) не сохранялись в веб-интерфейсе, в отличие от остальных настроек страницы "Настройки".

### Симптомы
- Настройки отображались в веб-интерфейсе
- При сохранении настроек через веб-форму новые значения не сохранялись
- В файле `settings.json` настройки присутствовали, но не обновлялись
- Остальные настройки (модель, пороги уверенности, формат экспорта и т.д.) сохранялись корректно

## 2. Причина

### Анализ проблемы
Проблема была обнаружена в файле `web/routes.py`. В функции `settings()` был старый код обработки POST запросов, который не включал новые настройки `model_type` и `use_optimization`.

### Конфликт кода
В приложении было два места обработки настроек:
1. **`web/settings.py`** - новый код с полной поддержкой всех настроек
2. **`web/routes.py`** - старый код без поддержки новых настроек

Старый код в `web/routes.py` переопределял настройки, которые обрабатывались в `web/settings.py`, что приводило к потере новых полей.

## 3. Решение

### 3.1 Исправление в web/routes.py
Добавлена поддержка новых настроек в функцию `settings()`:

```python
@app.route('/settings', methods=['GET', 'POST'])
def settings():
    if request.method == 'POST':
        action = request.form.get('action', 'save')
        
        if action == 'save':
            settings = load_settings()
            settings['model_file'] = request.form.get('model_file', 'model_clashmark.pt')
            settings['low_confidence'] = float(request.form.get('low_confidence', 0.3))
            settings['high_confidence'] = float(request.form.get('high_confidence', 0.7))
            settings['inference_mode'] = request.form.get('inference_mode', 'model')
            settings['export_format'] = request.form.get('export_format', 'standard')
            settings['manual_review_enabled'] = 'manual_review_enabled' in request.form
            # Добавляем новые настройки
            settings['model_type'] = request.form.get('model_type', 'mobilenet_v3_small')
            settings['use_optimization'] = 'use_optimization' in request.form
            save_settings(settings)
            flash('Настройки сохранены!', 'success')
```

### 3.2 Проверка обработки checkbox
Убедились, что checkbox для `use_optimization` обрабатывается корректно:
- Если checkbox отмечен: `'use_optimization' in request.form` возвращает `True`
- Если checkbox не отмечен: `'use_optimization' in request.form` возвращает `False`

### 3.3 Проверка обработки select
Убедились, что select для `model_type` обрабатывается корректно:
- Значение берется из `request.form.get('model_type', 'mobilenet_v3_small')`
- Если значение не передано, используется значение по умолчанию

## 4. Тестирование

### 4.1 Прямое тестирование
Создан и выполнен тест прямого сохранения настроек:
```
✅ model_type: mobilenet_v3_small (тип: <class 'str'>)
✅ use_optimization: True (тип: <class 'bool'>)
✅ model_type изменен успешно
✅ use_optimization изменен успешно
```

### 4.2 Тестирование файла настроек
Проверено, что настройки корректно сохраняются в файл `settings.json`:
```json
{
  "model_file": "model_clashmark.pt",
  "low_confidence": 0.3,
  "high_confidence": 0.7,
  "inference_mode": "model",
  "manual_review_enabled": true,
  "export_format": "bimstep",
  "model_type": "mobilenet_v3_small",
  "use_optimization": true
}
```

### 4.3 Тестирование обработки checkbox
Проверены различные сценарии:
- ✅ Checkbox отмечен → `use_optimization: True`
- ✅ Checkbox не отмечен → `use_optimization: False`
- ✅ Смешанный случай → корректная обработка

## 5. Результат

### 5.1 Исправленные проблемы
- ✅ Настройка "Архитектура модели" теперь сохраняется корректно
- ✅ Настройка "Оптимизация инференса" теперь сохраняется корректно
- ✅ Все остальные настройки продолжают работать
- ✅ Обратная совместимость сохранена

### 5.2 Поддерживаемые значения

#### Архитектура модели (`model_type`):
- `mobilenet_v3_small` - MobileNetV3 Small (Быстрая)
- `efficientnet_b0` - EfficientNet-B0 (Сбалансированная)
- `resnet18` - ResNet18 (Качественная)
- `mobilenet_v2` - MobileNetV2 (Альтернативная)

#### Оптимизация инференса (`use_optimization`):
- `True` - Включена
- `False` - Отключена

## 6. Файлы, подвергшиеся изменениям

1. **`web/routes.py`**
   - Добавлена поддержка `model_type` в функцию `settings()`
   - Добавлена поддержка `use_optimization` в функцию `settings()`
   - Исправлен конфликт с `web/settings.py`

2. **`settings.json`**
   - Уже содержал новые настройки (был обновлен ранее)
   - Проверена корректность структуры

## 7. Рекомендации

### Для пользователей:
- Теперь все настройки сохраняются корректно
- При изменении архитектуры модели или оптимизации инференса изменения сохраняются
- Можно безопасно переключаться между разными настройками

### Для разработчиков:
- При добавлении новых настроек обновлять код в `web/routes.py`
- Использовать единообразную обработку checkbox и select элементов
- Тестировать сохранение настроек при изменениях

## 8. Будущие улучшения

Возможные направления дальнейшего развития:
- Автоматическое сохранение настроек при изменении (без нажатия кнопки)
- Валидация настроек на стороне клиента
- Экспорт/импорт настроек
- Сброс настроек к значениям по умолчанию
- Уведомления об изменении настроек

## 9. Заключение

Проблема с сохранением настроек "Архитектура модели" и "Оптимизация инференса" была успешно решена. Основная причина заключалась в конфликте между старым и новым кодом обработки настроек. После исправления все настройки сохраняются корректно, и веб-интерфейс работает как ожидается. 