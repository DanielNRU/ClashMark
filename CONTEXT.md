# ClashMark — Контекст проекта

## Описание
ClashMark — система анализа коллизий в BIM/строительных проектах. Использует Python, Flask, PyTorch. Поддерживает автоматическую (алгоритм/ML) и ручную разметку, экспорт результатов в разные форматы.

---

## Архитектура

- **Backend**: Flask (web/routes.py, web/inference.py и др.)
- **ML**: PyTorch (ml/model.py, ml/dataset.py, ml/inference.py, ml/train.py)
- **Core**: Утилиты для работы с изображениями и XML (core/image_utils.py, core/xml_utils.py)
- **Frontend**: HTML (templates/), JS (static/scripts.js), CSS (static/style.css)
- **Данные**: XML-файлы с коллизиями, ZIP-архивы с изображениями, YAML с парами категорий

---

## Основные сценарии

1. **Загрузка XML и ZIP** — пользователь загружает файлы, система парсит и сопоставляет изображения.
2. **Анализ** — автоматическая разметка (алгоритм/ML), ручная разметка (через модальное окно).
3. **Экспорт** — результаты сохраняются в стандартном XML-формате Navisworks/в XML-формате BIMStep плагина Navisworks, учитывая ручную разметку.
4. **Статистика** — отображение итоговой и детальной статистики по источникам разметки.
5. **Обучение** — загрузка данных, тренировка модели, отображение метрик.

---

## Основные сущности

- **Коллизия**: clash_id, clash_name, element1_category, element2_category, image_href, cv_prediction, prediction_source, ...
- **Ручная разметка**: manual_review.json (clash_id, status)
- **Пары категорий**: category_pairs.yaml (can, cannot, visual)
- **Сессия**: временная папка с файлами, session_id

---

## API (основные эндпоинты)

- `/analyze` — анализ файлов, возвращает статистику, ссылки на скачивание, список для ручной разметки
- `/api/manual_review` — POST, сохраняет ручную разметку
- `/api/updated_stats/<session_id>` — GET, возвращает обновлённую статистику и переэкспортированные файлы
- `/download/<session_id>/<filename>` — скачивание результатов
- `/settings` — настройки инференса/экспорта
- `/api/settings` — получить текущие настройки

---

## Визуализация интерфейса

Скриншоты основных страниц и функций веб-приложения размещены в папке `images/` и приведены в README.md и INSTRUCTION.md для наглядности.

---

## Важные файлы

- **web/routes.py** — основной backend, обработка анализа, ручной разметки, экспорта, статистики
- **core/xml_utils.py** — парсинг и экспорт XML/BIMStep
- **core/image_utils.py** — поиск и нормализация путей к изображениям
- **ml/model.py** — определение ML-модели
- **ml/inference.py** — инференс модели
- **ml/dataset.py** — датасет для обучения/инференса
- **static/scripts.js** — логика фронта, ручная разметка, обновление статистики
- **templates/index.html** — главная страница анализа

---

## Ключевые моменты

- **Ручная разметка** должна дополнять разметку алгоритмом и моделью компьютерного зрения, перезасывая исходные предсказания категорий New и Reviewed  для коллизий которые были размеченны вручную.
- **Экспорт и статистика** всегда должны учитывать ручную разметку, если она есть.
- **Frontend** после ручной разметки запрашивает обновлённую статистику и обновляет UI.

---

## Пример структуры данных (DataFrame)

| clash_id | ... | cv_prediction | prediction_source | original_cv_prediction | original_prediction_source |
|----------|-----|---------------|------------------|-----------------------|---------------------------|
| 123      | ... | 1             | manual_review    | 0                     | algorithm                 |

---

## Пример ручной разметки (manual_review.json)

```
[
  {"clash_id": "123", "status": "Approved"},
  {"clash_id": "124", "status": "Active"}
]
```

---

## Пример пары категорий (category_pairs.yaml)

```
can:
  - [Стена, Окно]
cannot:
  - [Труба, Балка]
visual:
  - [Потолок, Светильник]
```

---

## Контакты и поддержка

- Основной разработчик: Daniil Melnik
- Документация: README.md, CONTEXT.md
- Вопросы: issues на GitHub 

---

## Контейнеризация (Docker)

- ClashMark поддерживает развёртывание через Docker (Dockerfile и docker-compose.yaml в корне).
- Для обмена файлами модели используется volume: папка model/ на хосте монтируется в /app/model внутри контейнера.
- Запуск: docker build -t clashmark . && docker run -p 5001:5001 -v $(pwd)/model:/app/model clashmark
- Или через docker-compose up --build 