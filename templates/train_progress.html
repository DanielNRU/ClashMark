{% extends 'base.html' %}
{% block title %}ClashMark — Прогресс обучения{% endblock %}
{% block content %}
<div class="page-title">
    Прогресс обучения модели
    <span class="info-icon" onclick="showInfo()" title="Информация о странице">ℹ️</span>
</div>

<div class="progress-container card">
    <div id="train-status" class="progress-block"></div>
    <div id="train-metrics" class="progress-block">
        <h3>Метрики</h3>
        <ul id="metrics-list"></ul>
    </div>
    <div id="train-graphs" class="progress-block">
        <h3>Графики</h3>
        <canvas id="lossChart" height="120"></canvas>
        <canvas id="accuracyChart" height="120"></canvas>
    </div>
    <div id="confusion-matrix-block" class="progress-block">
        <h3>Матрица ошибок</h3>
        <table id="confusion-matrix"></table>
    </div>
    <div id="train-log" class="progress-block"></div>
</div>

<!-- Модальное окно для информации -->
<div id="infoModal" class="info-modal" style="display:none;">
  <div class="info-modal-content">
    <span class="info-modal-close" onclick="closeInfo()">&times;</span>
    <div id="infoText"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let lossChart = null;
let accuracyChart = null;
let updateInterval = null;

function showInfo() {
    document.getElementById('infoText').innerText = 'На странице "Прогресс обучения" отображается текущий статус обучения модели, метрики, графики потерь и точности, а также матрица ошибок.';
    document.getElementById('infoModal').style.display = 'block';
}

function closeInfo() {
    document.getElementById('infoModal').style.display = 'none';
}

function updateProgress() {
    fetch('/train_progress_data')
        .then(response => response.json())
        .then(data => {
            updateStatus(data);
            updateMetrics(data);
            updateGraphs(data);
            updateConfusionMatrix(data);
            updateLog(data);
            
            if (data.status === 'done' || data.status === 'error') {
                clearInterval(updateInterval);
            }
        })
        .catch(error => {
            console.error('Ошибка получения прогресса:', error);
        });
}

function updateStatus(data) {
    const statusDiv = document.getElementById('train-status');
    if (data.status === 'start') {
        statusDiv.innerHTML = '<h3>Статус обучения</h3><p>Подготовка к обучению...</p>';
    } else if (data.status === 'done') {
        statusDiv.innerHTML = '<h3>Статус обучения</h3><p style="color: green;">Обучение завершено!</p>';
    } else if (data.status === 'error') {
        statusDiv.innerHTML = '<h3>Статус обучения</h3><p style="color: red;">Ошибка обучения</p>';
    } else if (data.started) {
        statusDiv.innerHTML = `
            <h3>Статус обучения</h3>
            <p>Эпоха: ${data.epoch}/${data.total_epochs}</p>
            <p>Батч: ${data.batch}/${data.total_batches}</p>
            <p>Потери: ${data.loss}</p>
        `;
    }
}

function updateMetrics(data) {
    const metricsList = document.getElementById('metrics-list');
    if (data.metrics) {
        let html = '';
        if (data.metrics.last_train_loss !== undefined) {
            html += `<li>Train Loss: ${data.metrics.last_train_loss}</li>`;
        }
        if (data.metrics.last_val_loss !== undefined && data.metrics.last_val_loss !== '') {
            html += `<li>Val Loss: ${data.metrics.last_val_loss}</li>`;
        }
        if (data.metrics.last_val_acc !== undefined && data.metrics.last_val_acc !== '') {
            html += `<li>Val Accuracy: ${data.metrics.last_val_acc}</li>`;
        }
        if (data.metrics.last_f1 !== undefined && data.metrics.last_f1 !== '') {
            html += `<li>F1: ${data.metrics.last_f1}</li>`;
        }
        if (data.metrics.last_recall !== undefined && data.metrics.last_recall !== '') {
            html += `<li>Recall: ${data.metrics.last_recall}</li>`;
        }
        if (data.metrics.last_precision !== undefined && data.metrics.last_precision !== '') {
            html += `<li>Precision: ${data.metrics.last_precision}</li>`;
        }
        if (data.metrics.final_accuracy !== undefined) {
            html += `<li><strong>Final Accuracy: ${data.metrics.final_accuracy}</strong></li>`;
        }
        if (data.metrics.final_f1 !== undefined) {
            html += `<li><strong>Final F1: ${data.metrics.final_f1}</strong></li>`;
        }
        if (data.metrics.final_recall !== undefined) {
            html += `<li><strong>Final Recall: ${data.metrics.final_recall}</strong></li>`;
        }
        if (data.metrics.final_precision !== undefined) {
            html += `<li><strong>Final Precision: ${data.metrics.final_precision}</strong></li>`;
        }
        metricsList.innerHTML = html;
    }
}

function updateGraphs(data) {
    if (data.metrics && data.metrics.val_precisions) {
        // Обновляем график потерь
        if (!lossChart) {
            const ctx = document.getElementById('lossChart').getContext('2d');
            lossChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Train Loss',
                        data: [],
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Val Loss',
                        data: [],
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Обновляем график точности
        if (!accuracyChart) {
            const ctx = document.getElementById('accuracyChart').getContext('2d');
            accuracyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Val Accuracy',
                        data: [],
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'F1',
                        data: [],
                        borderColor: '#9c27b0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }
        
        // Добавляем данные на графики
        const epochs = data.metrics.val_precisions.length;
        const labels = Array.from({length: epochs}, (_, i) => i + 1);
        
        lossChart.data.labels = labels;
        accuracyChart.data.labels = labels;
        
        // Обновляем данные (здесь нужно будет добавить реальные данные из метрик)
        if (data.metrics.val_precisions) {
            accuracyChart.data.datasets[0].data = data.metrics.val_precisions.map(v => v || 0);
        }
        if (data.metrics.val_f1s) {
            accuracyChart.data.datasets[1].data = data.metrics.val_f1s.map(v => v || 0);
        }
        
        lossChart.update();
        accuracyChart.update();
    }
}

function updateConfusionMatrix(data) {
    const matrixDiv = document.getElementById('confusion-matrix');
    if (data.metrics && data.metrics.confusion_matrix) {
        const matrix = data.metrics.confusion_matrix;
        let html = '<table style="border-collapse: collapse; margin: 0 auto;">';
        for (let i = 0; i < matrix.length; i++) {
            html += '<tr>';
            for (let j = 0; j < matrix[i].length; j++) {
                html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${matrix[i][j]}</td>`;
            }
            html += '</tr>';
        }
        html += '</table>';
        matrixDiv.innerHTML = html;
    }
}

function updateLog(data) {
    const logDiv = document.getElementById('train-log');
    if (data.log) {
        logDiv.innerHTML = `<h3>Лог обучения</h3><div style="background: #f8f9fa; padding: 16px; border-radius: 8px; max-height: 300px; overflow-y: auto;">${data.log}</div>`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.info-modal-close').onclick = closeInfo;
    document.getElementById('infoModal').onclick = function(e) { 
        if (e.target === this) closeInfo(); 
    };
    
    // Запускаем обновление прогресса
    updateProgress();
    updateInterval = setInterval(updateProgress, 1000);
});
</script>
{% endblock %} 