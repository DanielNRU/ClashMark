{% extends 'base.html' %}
{% block title %}ClashMark — Прогресс обучения{% endblock %}
{% block content %}
<div class="page-title">
    Прогресс обучения модели
    <span class="info-icon" onclick="showInfo()" title="Информация о странице">ℹ️</span>
</div>

<div class="progress-container card">
    <div id="train-status" class="progress-block"></div>
    <div id="train-graphs" class="progress-block">
        <h3>График метрик</h3>
        <canvas id="metricsChart" height="400" width="900" style="display: block; box-sizing: border-box; height: 400px; width: 900px;"></canvas>
    </div>
    <div id="train-metrics" class="progress-block">
        <h3>Метрики</h3>
        <ul id="metrics-list"></ul>
    </div>
    <div id="confusion-matrix-block" class="progress-block">
        <h3>Матрица ошибок</h3>
        <table id="confusion-matrix"></table>
    </div>
    <div id="train-log" class="progress-block"></div>
</div>

<!-- Модальное окно для информации -->
<div id="infoModal" class="info-modal" style="display:none;">
  <div class="info-modal-content">
    <span class="info-modal-close" onclick="closeInfo()">&times;</span>
    <div id="infoText"></div>
  </div>
</div>

<style>
.cm-table {
    border-collapse: collapse;
    margin: 12px 0;
}
.cm-table th, .cm-table td {
    border: 1px solid #bfc8da;
    padding: 8px 14px;
    text-align: center;
    font-size: 1.1em;
}
.cm-table th {
    background: #e6eaf2;
    color: #1a2a4f;
    font-weight: 600;
}
.cm-table td { background: #f4f6fa; }
.cm-table .cm-true { background: #e9fbe9; color: #357a38; font-weight: 600; }
.cm-table .cm-false { background: #ffeaea; color: #b71c1c; font-weight: 600; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let metricsChart = null;
let updateInterval = null;

function showInfo() {
    document.getElementById('infoText').innerText = 'На странице "Прогресс обучения" отображается текущий статус обучения модели, метрики, графики потерь и точности, а также матрица ошибок.';
    document.getElementById('infoModal').style.display = 'block';
}

function closeInfo() {
    document.getElementById('infoModal').style.display = 'none';
}

function updateProgress() {
    fetch('/api/train_progress')
        .then(response => response.json())
        .then(data => {
            updateStatus(data);
            updateMetrics(data);
            updateGraphs(data);
            updateConfusionMatrix(data);
            updateLog(data);
            
            if (data.status === 'done' || data.status === 'error') {
                clearInterval(updateInterval);
            }
        })
        .catch(error => {
            console.error('Ошибка получения прогресса:', error);
        });
}

function updateStatus(data) {
    const statusDiv = document.getElementById('train-status');
    if (data.status === 'start') {
        statusDiv.innerHTML = '<h3>Статус обучения</h3><p>Подготовка к обучению...</p>';
    } else if (data.status === 'done') {
        statusDiv.innerHTML = '<h3>Статус обучения</h3><p style="color: green;">Обучение завершено!</p>';
    } else if (data.status === 'error') {
        statusDiv.innerHTML = '<h3>Статус обучения</h3><p style="color: red;">Ошибка обучения</p>';
    } else if (data.started) {
        statusDiv.innerHTML = `
            <h3>Статус обучения</h3>
            <p>Эпоха: ${data.epoch}/${data.total_epochs}</p>
            <p>Батч: ${data.batch}/${data.total_batches}</p>
            <p>Потери: ${data.loss}</p>
        `;
    }
}

function updateMetrics(data) {
    const metricsList = document.getElementById('metrics-list');
    if (data.metrics && data.metrics.train_losses && data.metrics.val_losses) {
        let html = '';
        const n = data.metrics.train_losses.length;
        for (let i = 0; i < n; i++) {
            html += `<li>Эпоха ${i+1}: Train Loss: ${Number(data.metrics.train_losses[i]).toFixed(3)} | Val Loss: ${Number(data.metrics.val_losses[i]).toFixed(3)} | Val Accuracy: ${Number(data.metrics.val_accuracies[i]).toFixed(3)} | F1: ${Number(data.metrics.val_f1s[i]).toFixed(3)} | Recall: ${Number(data.metrics.val_recalls[i]).toFixed(3)} | Precision: ${Number(data.metrics.val_precisions[i]).toFixed(3)}</li>`;
        }
        metricsList.innerHTML = html;
    }
}

function updateGraphs(data) {
    if (data.metrics && data.metrics.val_accuracies && data.metrics.val_recalls && data.metrics.val_precisions && data.metrics.val_f1s) {
        const totalEpochs = data.total_epochs || data.metrics.val_accuracies.length;
        if (!metricsChart) {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            metricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: totalEpochs}, (_, i) => i + 1),
                    datasets: [
                        {label: 'Accuracy', data: Array(totalEpochs).fill(null), borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', tension: 0.1},
                        {label: 'Recall', data: Array(totalEpochs).fill(null), borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.1)', tension: 0.1},
                        {label: 'Precision', data: Array(totalEpochs).fill(null), borderColor: '#009688', backgroundColor: 'rgba(0, 150, 136, 0.1)', tension: 0.1},
                        {label: 'F1', data: Array(totalEpochs).fill(null), borderColor: '#2196f3', backgroundColor: 'rgba(33, 150, 243, 0.1)', tension: 0.1}
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }
        // labels всегда по totalEpochs
        metricsChart.data.labels = Array.from({length: totalEpochs}, (_, i) => i + 1);
        function fillMetric(arr) {
            return Array.from({length: totalEpochs}, (_, i) => (arr && arr[i] !== undefined ? arr[i] : null));
        }
        metricsChart.data.datasets[0].data = fillMetric(data.metrics.val_accuracies);
        metricsChart.data.datasets[1].data = fillMetric(data.metrics.val_recalls);
        metricsChart.data.datasets[2].data = fillMetric(data.metrics.val_precisions);
        metricsChart.data.datasets[3].data = fillMetric(data.metrics.val_f1s);
        metricsChart.update();
    }
}

function renderConfusionMatrix(matrix) {
    if (!Array.isArray(matrix) || !matrix.length || !Array.isArray(matrix[0])) return '<div style="color:#888">Нет данных</div>';
    const n = matrix.length;
    const m = Array.isArray(matrix[0]) ? matrix[0].length : 0;
    if (!m) return '<div style="color:#888">Нет данных</div>';
    const classLabels = n === 2 ? ['Критичные', 'Некритичные'] : Array.from({length: n}, (_, i) => `Класс ${i}`);
    let html = '<table class="cm-table">';
    html += '<tr><th rowspan="2">Факт/Прогноз</th><th colspan="' + m + '">Прогноз</th></tr>';
    html += '<tr>' + classLabels.map(l => `<th>${l}</th>`).join('') + '</tr>';
    for (let i = 0; i < n; i++) {
        html += `<tr><th>${classLabels[i]}</th>`;
        for (let j = 0; j < m; j++) {
            const val = (matrix[i] && matrix[i][j] !== undefined) ? matrix[i][j] : '';
            const cellClass = i === j ? 'cm-true' : 'cm-false';
            html += `<td class="${cellClass}">${val}</td>`;
        }
        html += '</tr>';
    }
    html += '</table>';
    return html;
}

function updateConfusionMatrix(data) {
    const block = document.getElementById('confusion-matrix-block');
    const matrixDiv = document.getElementById('confusion-matrix');
    if (data.status === 'done' && data.metrics && data.metrics.confusion_matrix) {
        block.style.display = '';
        matrixDiv.innerHTML = renderConfusionMatrix(data.metrics.confusion_matrix);
    } else {
        block.style.display = 'none';
        matrixDiv.innerHTML = '';
    }
}

function updateLog(data) {
    const logDiv = document.getElementById('train-log');
    if (data.log) {
        logDiv.innerHTML = `<h3>Лог обучения</h3><div style="background: #f8f9fa; padding: 16px; border-radius: 8px; max-height: 300px; overflow-y: auto;">${data.log}</div>`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.info-modal-close').onclick = closeInfo;
    document.getElementById('infoModal').onclick = function(e) { 
        if (e.target === this) closeInfo(); 
    };
    
    // Запускаем обновление прогресса
    updateProgress();
    updateInterval = setInterval(updateProgress, 1000);
});
</script>
{% endblock %} 