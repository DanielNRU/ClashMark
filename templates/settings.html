{% extends 'base.html' %}
{% block title %}ClashMark ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block content %}
<style>
.settings-container {
    max-width: 900px;
    margin: 32px auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px #0001;
    padding: 32px;
}
.settings-section {
    margin-bottom: 32px;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 24px;
}
.settings-title {
    font-size: 1.4em;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 12px;
}
.form-group {
    margin-bottom: 20px;
}
.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
    font-size: 14px;
}
.form-group input, .form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    background: #fff;
}
.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #23408e;
    box-shadow: 0 0 0 3px rgba(35, 64, 142, 0.1);
}
.form-group input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
    transform: scale(1.2);
}
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
.form-row.full-width {
    grid-template-columns: 1fr;
}
.form-row.half-width {
    grid-template-columns: 1fr 1fr;
}
.form-row.three-cols {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
.buttons-row {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
}
.settings-input {
    min-width: 320px;
    max-width: 520px;
    width: 100% !important;
    box-sizing: border-box;
}
#modelSelect.settings-input {
    min-width: 800px;
    max-width: 1400px;
}
.form-group input.settings-input,
.form-group select.settings-input {
    width: 100% !important;
    min-width: 320px;
    max-width: 520px;
    box-sizing: border-box;
}
.metric-item {
    background: #f8f9fa;
    padding: 20px 24px;
    border-radius: 12px;
    text-align: center;
    border: 1.5px solid #e9ecef;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px #0001;
    font-size: 18px;
    display: inline-block;
    width: 140px;
    flex-shrink: 0;
}
.metric-label {
    font-size: 13px;
    color: #6c757d;
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: #23408e;
}
.btn {
    padding: 14px 32px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 8px #0001;
    background: linear-gradient(90deg, #23408e 60%, #3b5998 100%);
    color: #fff;
}
.btn:hover {
    background: linear-gradient(90deg, #1a2a4f 60%, #23408e 100%);
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 4px 16px #0002;
}
.btn-danger {
    background: linear-gradient(90deg, #dc3545 60%, #b71c1c 100%);
    color: #fff;
}
.btn-danger:hover {
    background: linear-gradient(90deg, #b71c1c 60%, #dc3545 100%);
}
.confusion-matrix {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 16px #0001;
    overflow: hidden;
    margin-bottom: 24px;
    font-size: 16px;
    font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
}
.confusion-matrix th, .confusion-matrix td {
    padding: 16px 20px;
    text-align: center;
    border: none;
    font-weight: 600;
    transition: background 0.2s;
}
.confusion-matrix th {
    background: #23408e;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
}
.confusion-matrix th:hover {
    background: #1a2a4f;
}
.confusion-matrix tr {
    transition: background 0.2s;
}
.confusion-matrix tr:hover {
    background: #f0f4fa;
}
.confusion-matrix td {
    border-bottom: 1px solid #e9ecef;
    background: #fff;
    color: #23408e;
    font-weight: 600;
    font-size: 18px;
}
.confusion-matrix tr:last-child td {
    border-bottom: none;
}
.confusion-matrix td:first-child {
    background: #3b5998;
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.confusion-matrix td:first-child:hover {
    background: #23408e;
}
/* –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –º–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫ */
.confusion-matrix .tp, .confusion-matrix .tn {
    background: #e8f5e8 !important;
    color: #2e7d32 !important;
}
.confusion-matrix .fp, .confusion-matrix .fn {
    background: #fce4ec !important;
    color: #c2185b !important;
}
</style>

<div class="page-title">
    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    <span class="info-icon" onclick="showInfo()" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ">‚ÑπÔ∏è</span>
</div>

<div class="settings-container">
    <form method="post" id="settingsForm">
        <input type="hidden" name="action" id="formAction" value="save">
        
        <div class="settings-section">
            <div class="settings-title">
                ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏
            </div>
            <div class="form-row" style="gap:32px;">
                <div class="form-group">
                    <label>–§–∞–π–ª –º–æ–¥–µ–ª–∏:</label>
                    <select name="model_file" id="modelSelect" onchange="updateModelStats()" class="settings-input" style="min-width:800px;max-width:1600px;">
                        {% for file in model_files %}
                            <option value="{{ file }}" {% if settings.model_file == file %}selected{% endif %}>
                                {{ file }}
                                {% if model_metrics[file] %}
                                    ({{ model_metrics[file].model_type|default('‚Äî') }},
                                     E: {{ model_metrics[file].epochs|default('‚Äî') }}, 
                                     B: {{ model_metrics[file].batch_size|default('‚Äî') }}, 
                                     Acc: {{ model_metrics[file].final_accuracy|round(3)|default('‚Äî') }}, 
                                     Prec: {{ model_metrics[file].final_precision|round(3)|default('‚Äî') }}, 
                                     Rec: {{ model_metrics[file].final_recall|round(3)|default('‚Äî') }}, 
                                     F1: {{ model_metrics[file].final_f1|round(3)|default('‚Äî') }})
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row" style="gap:32px;">
                <div class="form-group">
                    <label>–ü–æ—Ä–æ–≥ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</label>
                    <input type="number" step="0.01" min="0" max="1" name="low_confidence" value="{{ settings.low_confidence }}" class="settings-input">
                </div>
                <div class="form-group">
                    <label>–ü–æ—Ä–æ–≥ –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</label>
                    <input type="number" step="0.01" min="0" max="1" name="high_confidence" value="{{ settings.high_confidence }}" class="settings-input">
                </div>
            </div>
            
            <div class="form-row" style="gap:32px;">
                <div class="form-group">
                    <label>–†–µ–∂–∏–º –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞:</label>
                    <select name="inference_mode" class="settings-input">
                        <option value="model" {% if settings.inference_mode == 'model' %}selected{% endif %}>–ú–æ–¥–µ–ª—å</option>
                        <option value="algorithm" {% if settings.inference_mode == 'algorithm' %}selected{% endif %}>–ê–ª–≥–æ—Ä–∏—Ç–º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:</label>
                    <select name="export_format" class="settings-input">
                        <option value="standard" {% if settings.export_format == 'standard' %}selected{% endif %}>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</option>
                        <option value="bimstep" {% if settings.export_format == 'bimstep' %}selected{% endif %}>BIM Step</option>
                    </select>
                </div>
            </div>
            
            <!-- –£–¥–∞–ª—ë–Ω –±–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥–µ–ª–∏ -->
            
            <div class="form-row" style="gap:32px;">
                <!-- –ë—ã–ª select –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, —Ç–µ–ø–µ—Ä—å –µ–≥–æ –Ω–µ—Ç -->
            </div>
            
            <div class="form-group" style="display: flex; gap: 32px; align-items: center;">
                <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                    <input type="checkbox" name="manual_review_enabled" {% if settings.manual_review_enabled %}checked{% endif %}>
                    –í–∫–ª—é—á–∏—Ç—å —Ä—É—á–Ω—É—é —Ä–∞–∑–º–µ—Ç–∫—É
                </label>
            </div>
        </div>
        
        <div class="buttons-row">
            <button type="submit" class="btn btn-primary" onclick="setAction('save')">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <button type="submit" class="btn btn-danger" onclick="setAction('delete_model')">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
            </button>
            <button type="submit" class="btn btn-danger" onclick="setAction('clear_cache')">
                üßπ –£–¥–∞–ª–∏—Ç—å –∫—ç—à
            </button>
        </div>
    </form>
    
    <div id="modelStatsSection" class="settings-section" style="display: none; margin-top: 48px;">
        <div class="settings-title">
            üìä –ú–µ—Ç—Ä–∏–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        </div>
        
        <div class="metrics-section" style="margin-bottom:24px;">
            <div style="display:flex;gap:16px;justify-content:center;flex-wrap:nowrap;">
                <div class="metric-item">
                    <div class="metric-label">Accuracy</div>
                    <div class="metric-value" id="accuracyValue">‚Äî</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">F1-score</div>
                    <div class="metric-value" id="f1Value">‚Äî</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Recall</div>
                    <div class="metric-value" id="recallValue">‚Äî</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Precision</div>
                    <div class="metric-value" id="precisionValue">‚Äî</div>
                </div>
            </div>
        </div>
        <div id="modelStatsExtra" style="margin-bottom:24px;"></div>
        <h4>üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</h4>
        <div class="category-pairs-block">
            <input type="text" id="categoryPairsSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º..." class="form-control" style="margin-bottom:12px;max-width:320px;display:none;">
            <div id="categoryPairsList"></div>
        </div>
        
        <h4>üéØ –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫:</h4>
        <div id="confusionMatrix">
        </div>
    </div>
    
    {% if error %}
        <div class="error-block"><span class="icon">&#9888;</span> {{ error|safe }}</div>
    {% endif %}
    {% if message %}
        <div class="message-block"><span class="icon">&#10003;</span> {{ message }}</div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
<div id="infoModal" class="info-modal" style="display:none;">
  <div class="info-modal-content">
    <span class="info-modal-close" onclick="closeInfo()">&times;</span>
    <div id="infoText"></div>
  </div>
</div>

<script id="modelMetricsData" type="application/json">{{ model_metrics|tojson|safe }}</script>
<script>
// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π –∏–∑ JSON-—Å–∫—Ä–∏–ø—Ç–∞
const modelMetrics = JSON.parse(document.getElementById('modelMetricsData').textContent);

function setAction(action) {
    document.getElementById('formAction').value = action;
}

function renderCategoryPairsTable(pairs, sortCol = 2, sortDir = 'desc') {
    const container = document.getElementById('categoryPairsList');
    container.innerHTML = '';
    if (!pairs || pairs.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –ø–∞—Ä</div>';
        return;
    }
    const search = (document.getElementById('categoryPairsSearch')?.value || '').toLowerCase();
    let filtered = pairs.filter(pair =>
        pair[0].toLowerCase().includes(search) ||
        pair[1].toLowerCase().includes(search)
    );
    filtered.sort((a, b) => {
        let v1 = a[sortCol], v2 = b[sortCol];
        if (sortCol === 2) { v1 = +v1; v2 = +v2; }
        if (v1 < v2) return sortDir === 'asc' ? -1 : 1;
        if (v1 > v2) return sortDir === 'asc' ? 1 : -1;
        return 0;
    });
    let html = '<table class="category-pairs-table"><thead><tr>' +
        '<th data-col="0">–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1</th>' +
        '<th data-col="1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è 2</th>' +
        '<th data-col="2">–ö–æ–ª-–≤–æ</th>' +
        '</tr></thead><tbody>';
    filtered.forEach(pair => {
        html += `<tr><td>${pair[0]}</td><td>${pair[1]}</td><td>${pair[2]}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∏–∫—É
    const ths = container.querySelectorAll('th');
    ths.forEach(th => {
        th.style.cursor = 'pointer';
        th.onclick = function() {
            let col = +th.getAttribute('data-col');
            let dir = (window.categoryPairsSortCol === col && window.categoryPairsSortDir === 'asc') ? 'desc' : 'asc';
            window.categoryPairsSortCol = col;
            window.categoryPairsSortDir = dir;
            renderCategoryPairsTable(window.categoryPairsData, col, dir);
        };
    });
}

function renderConfusionMatrixSettings(matrix) {
    if (!Array.isArray(matrix) || !matrix.length || !Array.isArray(matrix[0])) return '<div style="color:#888">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    
    const n = matrix.length;
    const m = matrix[0].length;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –∫–ª–∞—Å—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞ –º–∞—Ç—Ä–∏—Ü—ã
    const classLabels = n === 2 ? ['Approve', 'Active'] : 
                       n === 3 ? ['Approve', 'Active', 'Reviewed'] : 
                       Array.from({length: n}, (_, i) => `–ö–ª–∞—Å—Å ${i}`);
    
    let html = `<table class="confusion-matrix">
        <thead><tr><th>–ü—Ä–æ–≥–Ω–æ–∑ \\ –§–∞–∫—Ç</th>`;
    
    for (let j = 0; j < m; j++) {
        html += `<th>${classLabels[j]}</th>`;
    }
    html += `</tr></thead><tbody>`;
    
    for (let i = 0; i < n; i++) {
        html += `<tr><th>${classLabels[i]}</th>`;
        for (let j = 0; j < m; j++) {
            const value = matrix[i][j];
            const isDiagonal = i === j;
            // TP/TN (–¥–∏–∞–≥–æ–Ω–∞–ª—å) - –∑–µ–ª—ë–Ω—ã–π, FP/FN (–Ω–µ –¥–∏–∞–≥–æ–Ω–∞–ª—å) - —Ä–æ–∑–æ–≤—ã–π
            const cssClass = isDiagonal ? 'tp' : 'fp';
            html += `<td class="${cssClass}">${value}</td>`;
        }
        html += `</tr>`;
    }
    html += `</tbody></table>`;
    
    return html;
}

function updateModelInfo() {
    const selectedModelType = document.querySelector('select[name="model_type"]').value;
    const modelInfo = {
        'mobilenet_v3_small': {
            'speed': '–ë—ã—Å—Ç—Ä–∞—è',
            'accuracy': '–•–æ—Ä–æ—à–∞—è',
            'params': '~2.5M',
            'description': '–û–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö.'
        },
        'efficientnet_b0': {
            'speed': '–°—Ä–µ–¥–Ω—è—è',
            'accuracy': '–õ—É—á—à–∞—è',
            'params': '~5.3M',
            'description': '–•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤.'
        },
        'resnet18': {
            'speed': '–ú–µ–¥–ª–µ–Ω–Ω–∞—è',
            'accuracy': '–û—Ç–ª–∏—á–Ω–∞—è',
            'params': '~11.7M',
            'description': '–õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–¥–∞—á.'
        },
        'mobilenet_v2': {
            'speed': '–ë—ã—Å—Ç—Ä–∞—è',
            'accuracy': '–•–æ—Ä–æ—à–∞—è',
            'params': '~3.5M',
            'description': '–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ MobileNetV3. –°—Ç–∞–±–∏–ª—å–Ω–∞—è –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞.'
        }
    };
    
    const info = modelInfo[selectedModelType] || modelInfo['mobilenet_v3_small'];
    const infoDiv = document.getElementById('modelInfo');
    const infoText = document.getElementById('modelInfoText');
    
    infoText.innerHTML = `
        <div style="margin-bottom: 8px;"><strong>–°–∫–æ—Ä–æ—Å—Ç—å:</strong> ${info.speed}</div>
        <div style="margin-bottom: 8px;"><strong>–¢–æ—á–Ω–æ—Å—Ç—å:</strong> ${info.accuracy}</div>
        <div style="margin-bottom: 8px;"><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong> ${info.params}</div>
        <div><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${info.description}</div>
    `;
    
    infoDiv.style.display = 'block';
}

function updateModelStats() {
    const selectedModel = document.getElementById('modelSelect').value;
    const statsSection = document.getElementById('modelStatsSection');
    const extraStats = document.getElementById('modelStatsExtra');
    if (modelMetrics[selectedModel]) {
        const metrics = modelMetrics[selectedModel];
        document.getElementById('accuracyValue').textContent = metrics.final_accuracy ? metrics.final_accuracy.toFixed(3) : '‚Äî';
        document.getElementById('f1Value').textContent = metrics.final_f1 ? metrics.final_f1.toFixed(3) : '‚Äî';
        document.getElementById('recallValue').textContent = metrics.final_recall ? metrics.final_recall.toFixed(3) : '‚Äî';
        document.getElementById('precisionValue').textContent = metrics.final_precision ? metrics.final_precision.toFixed(3) : '‚Äî';
        extraStats.innerHTML = '';
        if (metrics.category_pairs && metrics.category_pairs.length) {
            window.categoryPairsSortCol = 2;
            window.categoryPairsSortDir = 'desc';
            window.categoryPairsData = metrics.category_pairs;
            document.getElementById('categoryPairsSearch').style.display = '';
            renderCategoryPairsTable(window.categoryPairsData, window.categoryPairsSortCol, window.categoryPairsSortDir);
        } else {
            document.getElementById('categoryPairsSearch').style.display = 'none';
            document.getElementById('categoryPairsList').innerHTML = '';
        }
        // --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –º–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫ ---
        let confusionMatrix = null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞, –≥–¥–µ –º–æ–∂–µ—Ç –±—ã—Ç—å confusion_matrix
        if (metrics.confusion_matrix && Array.isArray(metrics.confusion_matrix) && metrics.confusion_matrix.length > 0) {
            confusionMatrix = metrics.confusion_matrix;
        } else if (metrics.metrics && metrics.metrics.confusion_matrix && Array.isArray(metrics.metrics.confusion_matrix) && metrics.metrics.confusion_matrix.length > 0) {
            confusionMatrix = metrics.metrics.confusion_matrix;
        }
        
        let matrixHtml = '<div style="color:#888">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        if (confusionMatrix && Array.isArray(confusionMatrix[0])) {
            matrixHtml = renderConfusionMatrixSettings(confusionMatrix);
        }
        document.getElementById('confusionMatrix').innerHTML = matrixHtml;
        statsSection.style.display = 'block';
    } else {
        extraStats.innerHTML = '';
        document.getElementById('categoryPairsSearch').style.display = 'none';
        document.getElementById('categoryPairsList').innerHTML = '';
        document.getElementById('confusionMatrix').innerHTML = '';
        statsSection.style.display = 'none';
    }
}

// –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É—é showCategoryPairsTable –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞:
function showCategoryPairsTable(pairs) {
    window.categoryPairsSortCol = window.categoryPairsSortCol ?? 2;
    window.categoryPairsSortDir = window.categoryPairsSortDir ?? 'desc';
    window.categoryPairsData = pairs;
    const searchInput = document.getElementById('categoryPairsSearch');
    if (pairs && pairs.length) {
        if (searchInput) searchInput.style.display = '';
        renderCategoryPairsTable(pairs, window.categoryPairsSortCol, window.categoryPairsSortDir);
    } else {
        if (searchInput) searchInput.style.display = 'none';
        const list = document.getElementById('categoryPairsList');
        if (list) list.innerHTML = '';
    }
}

function showInfo() {
    document.getElementById('infoText').innerText = '–í "–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö" –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å, –ø–æ—Ä–æ–≥–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —Ä–µ–∂–∏–º –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –∏ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ—Ä–æ–≥ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ ‚Äî –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–¥–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç –∫–æ–ª–ª–∏–∑–∏—é —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–π, –≤—ã—à–µ –≤—ã—Å–æ–∫–æ–≥–æ ‚Äî –∞–∫—Ç–∏–≤–Ω–æ–π, –º–µ–∂–¥—É –Ω–∏–º–∏ ‚Äî —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.';
    document.getElementById('infoModal').style.display = 'block';
}

function closeInfo() {
    document.getElementById('infoModal').style.display = 'none';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateModelStats();
    updateModelInfo();
    document.querySelector('.info-modal-close').onclick = closeInfo;
    document.getElementById('infoModal').onclick = function(e) { 
        if (e.target === this) closeInfo(); 
    };
    const searchInput = document.getElementById('categoryPairsSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            showCategoryPairsTable(window.categoryPairsData);
        });
    }
});

// === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞ –º–æ–¥–µ–ª–∏ ===
document.addEventListener('DOMContentLoaded', function() {
    const modelFileSelect = document.querySelector('select[name="model_file"]');
    const modelTypeSelect = document.querySelector('select[name="model_type"]');
    if (modelFileSelect && modelTypeSelect) {
        modelFileSelect.addEventListener('change', function() {
            const selectedModel = this.value;
            fetch(`/api/model_info?model_file=${encodeURIComponent(selectedModel)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.model_type) {
                        modelTypeSelect.value = data.model_type;
                        updateModelInfo();
                    }
                });
        });
    }
});
</script>
{% endblock %} 